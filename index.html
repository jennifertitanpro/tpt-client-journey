<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPT Client Journey - ServiceTitan Implementation Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@octokit/rest@19.0.13/dist/octokit-rest.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .progress-ring { transform: rotate(-90deg); }
        input:disabled, select:disabled, textarea:disabled { 
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        /* Scrollbar for navigation tabs */
        nav::-webkit-scrollbar {
            height: 4px;
        }
        nav::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        nav::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading TPT Client Journey Platform...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 z-40 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">TPT Client Journey</h1>
                <p class="text-gray-600">ServiceTitan Implementation Platform</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="tokenLogin()" class="w-full bg-gray-900 text-white py-3 px-4 rounded-lg hover:bg-gray-800 transition flex items-center justify-center">
                    <i class="fab fa-github mr-2"></i>
                    Sign in with GitHub
                </button>
                
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">Or use demo mode</span>
                    </div>
                </div>
                
                <button onclick="demoLogin('client')" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                    Demo: Client View
                </button>
                
                <button onclick="demoLogin('coach')" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition">
                    Demo: Coach View
                </button>
            </div>
            
            <div class="mt-6 text-center text-xs text-gray-500">
                <p>By Titan Pro Technologies</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold text-gray-800">ServiceTitan Journey Tracker</h1>
                        <span class="ml-4 px-3 py-1 text-sm rounded-full" id="userRole"></span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="saveAllData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <i class="fas fa-save mr-2"></i>Save All
                        </button>
                        <button onclick="exportData()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <span class="text-sm text-gray-600" id="userName"></span>
                        <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Client Selector (Coach Only) -->
        <div id="clientSelector" class="hidden bg-gray-100 py-4">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700">Select Client:</label>
                    <select id="clientDropdown" onchange="loadClient(this.value)" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Choose a client...</option>
                    </select>
                    <button onclick="addNewClient()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add Client
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Dashboard -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Progress Overview -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Overall Progress</h3>
                        <div class="relative inline-block">
                            <svg width="120" height="120" class="progress-ring">
                                <circle cx="60" cy="60" r="54" stroke="#e5e7eb" stroke-width="12" fill="none"/>
                                <circle id="progressCircle" cx="60" cy="60" r="54" stroke="#3b82f6" stroke-width="12" 
                                        fill="none" stroke-dasharray="339.292" stroke-dashoffset="339.292" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="progressPercent" class="text-2xl font-bold text-gray-800">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-3">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Client Information</h3>
                        <div id="clientInfo" class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Tenant ID:</span>
                                <span id="tenantIdDisplay" class="font-medium ml-2">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Company:</span>
                                <span id="companyDisplay" class="font-medium ml-2">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Technicians:</span>
                                <span id="technicianCount" class="font-medium ml-2">0</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Employees:</span>
                                <span id="employeeCount" class="font-medium ml-2">0</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Status:</span>
                                <span id="statusDisplay" class="font-medium ml-2">Active</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Last Updated:</span>
                                <span id="lastUpdatedDisplay" class="font-medium ml-2">-</span>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                            <div class="bg-green-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-green-600" id="completedCount">0</div>
                                <div class="text-xs text-gray-600">Completed</div>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-yellow-600" id="inProgressCount">0</div>
                                <div class="text-xs text-gray-600">In Progress</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-gray-600" id="notApplicableCount">0</div>
                                <div class="text-xs text-gray-600">Not Applicable</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex overflow-x-auto">
                        <button onclick="switchTab('settings')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600" data-tab="settings">
                            ServiceTitan Settings
                        </button>
                        <button onclick="switchTab('people')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="people">
                            People & Payroll
                        </button>
                        <button onclick="switchTab('integrations')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="integrations">
                            Integrations
                        </button>
                        <button onclick="switchTab('operations')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="operations">
                            Operations
                        </button>
                        <button onclick="switchTab('phones')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="phones">
                            Phones & Comms
                        </button>
                        <button onclick="switchTab('technicians')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="technicians">
                            Technicians
                        </button>
                        <button onclick="switchTab('employees')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="employees">
                            Employees
                        </button>
                        <button onclick="switchTab('skills')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="skills">
                            Skills & Job Types
                        </button>
                        <button onclick="switchTab('zones')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="zones">
                            Service Zones
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <div id="settings-tab" class="tab-content active"></div>
                    <div id="people-tab" class="tab-content"></div>
                    <div id="integrations-tab" class="tab-content"></div>
                    <div id="operations-tab" class="tab-content"></div>
                    <div id="phones-tab" class="tab-content"></div>
                    <div id="technicians-tab" class="tab-content"></div>
                    <div id="employees-tab" class="tab-content"></div>
                    <div id="skills-tab" class="tab-content"></div>
                    <div id="zones-tab" class="tab-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            // GitHub OAuth App Client ID (public, safe to expose)
            GITHUB_CLIENT_ID: 'Ov23liVgHG3gjkqmbxfS',
            
            // Your backend OAuth handler URL - UPDATED!
            BACKEND_URL: 'https://titan-pro-client-journey.netlify.app/.netlify/functions',
            
            // GitHub organization and repository
            GITHUB_ORG: 'titan-pro-technologies',
            GITHUB_REPO_OWNER: 'jennifertitanpro',
            GITHUB_REPO_NAME: 'tpt-client-journey'
        };

        // ===== GLOBAL STATE =====
        let currentUser = null;
        let currentClient = null;
        let clientData = {};
        let octokit = null;

        // ===== DATA STRUCTURE =====
        const journeyStructure = {
            settings: {
                title: "ServiceTitan Settings",
                sections: {
                    tenant: {
                        title: "Tenant Information",
                        fields: [
                            { id: "tenantId", label: "Tenant ID", type: "text", required: true },
                            { id: "tenantName", label: "Tenant Name", type: "text", required: true }
                        ]
                    },
                    billing: {
                        title: "Billing Information",
                        fields: [
                            { id: "bankAccount", label: "Bank Account Connection", type: "checkbox" }
                        ]
                    },
                    company: {
                        title: "Company Profile Setup",
                        fields: [
                            { id: "companyName", label: "Company Name", type: "text", required: true },
                            { id: "streetAddress", label: "Street Address", type: "text" },
                            { id: "city", label: "City", type: "text" },
                            { id: "state", label: "State", type: "text" },
                            { id: "zipCode", label: "Zip Code", type: "text" },
                            { id: "phoneNumber", label: "Phone Number", type: "text" },
                            { id: "einNumber", label: "EIN Number", type: "text" }
                        ]
                    },
                    customerTypes: {
                        title: "Customer Types",
                        fields: [
                            { id: "customerTypes", label: "Customer Types Configuration", type: "textarea", 
                              placeholder: "List customer types (e.g., Residential, Commercial, Property Management)" }
                        ]
                    },
                    textMessaging: {
                        title: "Text Messaging Registration",
                        fields: [
                            { id: "textRegStatus", label: "Registration Status", type: "select", 
                              options: ["Not Started", "Submitted", "Approved"] },
                            { id: "optInSetup", label: "Opt-In Requests Setup", type: "checkbox" }
                        ]
                    }
                }
            },
            people: {
                title: "People & Payroll",
                sections: {
                    employees: {
                        title: "People Management",
                        fields: [
                            { id: "employeesAdded", label: "Employees Added", type: "checkbox" },
                            { id: "techniciansAdded", label: "Technicians Added", type: "checkbox" },
                            { id: "skillsConfigured", label: "Skills Configured", type: "checkbox" },
                            { id: "rolesConfigured", label: "Role Permissions Set Up", type: "checkbox" }
                        ]
                    },
                    payroll: {
                        title: "Payroll Configuration",
                        fields: [
                            { id: "timesheetCodes", label: "Timesheet Codes", type: "checkbox" },
                            { id: "payrollProfile1", label: "Payroll Profile 1 Name", type: "text" },
                            { id: "payrollProfile2", label: "Payroll Profile 2 Name", type: "text" },
                            { id: "payrollProfile3", label: "Payroll Profile 3 Name", type: "text" },
                            { id: "payrollProfile4", label: "Payroll Profile 4 Name", type: "text" }
                        ]
                    }
                }
            },
            integrations: {
                title: "Integrations",
                sections: {
                    alerts: {
                        title: "Alerts Configuration",
                        fields: [
                            { id: "alertsSetup", label: "Alerts Configured", type: "checkbox" }
                        ]
                    },
                    bookingProviders: {
                        title: "Booking Providers",
                        fields: [
                            { id: "angiAds", label: "Angi Ads", type: "checkbox" },
                            { id: "angiLeads", label: "Angi Leads", type: "checkbox" },
                            { id: "facebookAds", label: "Facebook Ads", type: "checkbox" },
                            { id: "wpForms", label: "WP Forms", type: "checkbox" },
                            { id: "networx", label: "Networx", type: "checkbox" },
                            { id: "thumbtack", label: "Thumbtack", type: "checkbox" }
                        ]
                    },
                    financing: {
                        title: "Financing Partners",
                        fields: [
                            { id: "greensky", label: "GreenSky", type: "checkbox" },
                            { id: "turns", label: "Turns", type: "checkbox" },
                            { id: "goodleap", label: "GoodLeap", type: "checkbox" },
                            { id: "wellsFargo", label: "Wells Fargo", type: "checkbox" },
                            { id: "serviceFinance", label: "Service Finance", type: "checkbox" }
                        ]
                    },
                    other: {
                        title: "Other Integrations",
                        fields: [
                            { id: "gps", label: "GPS Integration", type: "checkbox" },
                            { id: "jobTypeMapping", label: "Job Type Mapping", type: "checkbox" },
                            { id: "mobile", label: "Mobile Configuration", type: "checkbox" },
                            { id: "paymentProcessing", label: "Payment Processing", type: "checkbox" },
                            { id: "quickbooks", label: "QuickBooks Connected", type: "checkbox" }
                        ]
                    }
                }
            },
            operations: {
                title: "Operations",
                sections: {
                    dispatch: {
                        title: "Dispatch Configuration",
                        fields: [
                            { id: "dispatchAlerts", label: "Dispatch Alerts Configured", type: "checkbox" },
                            { id: "clockInOut", label: "Clock In/Out Configuration", type: "select",
                              options: ["Disabled", "Enabled"] },
                            { id: "jobConfirmations", label: "Job Confirmations Enabled", type: "checkbox" },
                            { id: "teamsManagement", label: "Teams Management Setup", type: "checkbox" }
                        ]
                    },
                    marketingPro: {
                        title: "Marketing Pro",
                        fields: [
                            { id: "customFields", label: "Custom Fields Setup", type: "checkbox" },
                            { id: "companyDetails", label: "Company Details Entered", type: "checkbox" },
                            { id: "reputationMgmt", label: "Reputation Management - Auto-Verify Reviews", type: "checkbox" },
                            { id: "advancedSurveys", label: "Advanced Survey Creation", type: "checkbox" },
                            { id: "reviewResponse", label: "Review Response Generation", type: "checkbox" }
                        ]
                    },
                    capacityPlanning: {
                        title: "Capacity Planning",
                        fields: [
                            { id: "businessUnitGroups", label: "Business Unit Groups", type: "text" },
                            { id: "realTimeAvailability", label: "Real Time Availability", type: "checkbox" },
                            { id: "arrivalWindows", label: "Arrival Windows Configuration", type: "text",
                              placeholder: "e.g., 2-hour, 4-hour windows" },
                            { id: "businessHours", label: "Business Hours", type: "text",
                              placeholder: "e.g., Mon-Fri 8AM-5PM, Sat 9AM-2PM" }
                        ]
                    },
                    purchasing: {
                        title: "Purchasing & Inventory",
                        fields: [
                            { id: "autoCreateBill", label: "Auto Create Bill when PO Received", type: "checkbox" },
                            { id: "inventoryTrucks", label: "Inventory Locations - Trucks", type: "checkbox" },
                            { id: "warehouseAddress", label: "Warehouse Address", type: "text" },
                            { id: "purchaseOrderTypes", label: "Purchase Order Types", type: "text" },
                            { id: "returnTypes", label: "Return Types", type: "text" },
                            { id: "vendorsList", label: "Vendors List", type: "textarea",
                              placeholder: "List all vendors (one per line)" }
                        ]
                    },
                    businessUnits: {
                        title: "Business Units & Campaigns",
                        fields: [
                            { id: "businessUnitName", label: "Business Unit Name", type: "text" },
                            { id: "officialName", label: "Official Name", type: "text" },
                            { id: "buPhoneNumber", label: "Phone Number", type: "text" },
                            { id: "trade", label: "Trade", type: "text" },
                            { id: "division", label: "Division", type: "text" },
                            { id: "invoiceHeader", label: "Invoice Header", type: "textarea" },
                            { id: "invoiceMessage", label: "Invoice Message", type: "textarea" },
                            { id: "authParagraph", label: "Authorization Paragraph", type: "textarea" },
                            { id: "ackParagraph", label: "Acknowledgment Paragraph", type: "textarea" },
                            { id: "estimateAuth", label: "Estimate Authorization Paragraph", type: "textarea" },
                            { id: "termsConditions", label: "Terms & Conditions", type: "textarea" },
                            { id: "callReasons", label: "Call Reasons Setup", type: "checkbox" },
                            { id: "campaignCategories", label: "Campaign Categories Setup", type: "checkbox" },
                            { id: "campaigns", label: "Campaigns Created", type: "checkbox" },
                            { id: "phoneNumbersCampaigns", label: "Phone Numbers Added to Campaigns", type: "checkbox" }
                        ]
                    }
                }
            },
            phones: {
                title: "Phones & Communications",
                sections: {
                    phoneConfig: {
                        title: "Phone Configuration",
                        fields: [
                            { id: "callRecording", label: "Call Recording Enabled", type: "checkbox" },
                            { id: "outboundRecording", label: "Outbound Recording Enabled", type: "checkbox" },
                            { id: "emergencyFallback", label: "Emergency Fallback Numbers Added", type: "checkbox" },
                            { id: "phoneNumbersPorted", label: "Phone Numbers Ported", type: "checkbox" },
                            { id: "outboundSMS", label: "Outbound SMS/MMS Number Applied", type: "checkbox" }
                        ]
                    },
                    chat: {
                        title: "Chat Configuration",
                        fields: [
                            { id: "chatPhoneNumber", label: "Chat Phone Number Setup", type: "checkbox" },
                            { id: "chatPermissions", label: "Chat Permissions Configured", type: "checkbox" },
                            { id: "chatEnabled", label: "Chat Enabled", type: "checkbox" },
                            { id: "autoresponder", label: "Autoresponder with Company Name", type: "checkbox" }
                        ]
                    },
                    notifications: {
                        title: "Customer Notifications",
                        fields: [
                            { id: "bookingConfirmations", label: "Booking Confirmations Enabled", type: "checkbox" },
                            { id: "reminderNotifications", label: "Reminder Notifications Enabled", type: "checkbox" },
                            { id: "dispatchNotifications", label: "Dispatch Notifications Enabled", type: "checkbox" },
                            { id: "completionSurveys", label: "Job Completion Surveys", type: "select",
                              options: ["Disabled", "Enabled"] },
                            { id: "customerPortal", label: "Customer Portal", type: "select",
                              options: ["Disabled", "Enabled"] }
                        ]
                    }
                }
            },
            technicians: {
                title: "Technicians",
                type: "list",
                fields: [
                    { id: "firstName", label: "First Name", type: "text", required: true },
                    { id: "lastName", label: "Last Name", type: "text", required: true },
                    { id: "email", label: "Email", type: "text" },
                    { id: "phone", label: "Phone", type: "text" },
                    { id: "employeeId", label: "Employee ID", type: "text" },
                    { id: "role", label: "Role/Title", type: "text" },
                    { id: "skills", label: "Skills", type: "multiselect", options: [] },
                    { id: "certifications", label: "Certifications", type: "text" },
                    { id: "hireDate", label: "Hire Date", type: "date" },
                    { id: "active", label: "Active", type: "checkbox" }
                ]
            },
            employees: {
                title: "Employees",
                type: "list",
                fields: [
                    { id: "firstName", label: "First Name", type: "text", required: true },
                    { id: "lastName", label: "Last Name", type: "text", required: true },
                    { id: "email", label: "Email", type: "text" },
                    { id: "phone", label: "Phone", type: "text" },
                    { id: "employeeId", label: "Employee ID", type: "text" },
                    { id: "department", label: "Department", type: "select", 
                      options: ["Office", "Field", "Sales", "Management", "Support"] },
                    { id: "position", label: "Position", type: "text" },
                    { id: "hireDate", label: "Hire Date", type: "date" },
                    { id: "active", label: "Active", type: "checkbox" }
                ]
            },
            skills: {
                title: "Skills & Job Types",
                sections: {
                    skillsList: {
                        title: "Skills Management",
                        type: "list",
                        itemLabel: "Skill",
                        fields: [
                            { id: "skillName", label: "Skill Name", type: "text", required: true },
                            { id: "category", label: "Category", type: "select",
                              options: ["Plumbing", "HVAC", "Electrical", "General", "Specialty"] },
                            { id: "description", label: "Description", type: "text" },
                            { id: "requiresCert", label: "Requires Certification", type: "checkbox" }
                        ]
                    },
                    jobTypes: {
                        title: "Job Types",
                        type: "list",
                        itemLabel: "Job Type",
                        fields: [
                            { id: "jobTypeName", label: "Job Type Name", type: "text", required: true },
                            { id: "category", label: "Category", type: "select",
                              options: ["Service", "Install", "Maintenance", "Inspection", "Emergency"] },
                            { id: "businessUnit", label: "Business Unit", type: "text" },
                            { id: "duration", label: "Typical Duration (hours)", type: "number" },
                            { id: "requiredSkills", label: "Required Skills", type: "text" },
                            { id: "active", label: "Active", type: "checkbox" }
                        ]
                    }
                }
            },
            zones: {
                title: "Service Zones",
                sections: {
                    zoneConfiguration: {
                        title: "Zone Setup",
                        fields: [
                            { id: "zonesConfigured", label: "Service Zones Configured", type: "checkbox" },
                            { id: "primaryZone", label: "Primary Service Zone", type: "text" },
                            { id: "secondaryZones", label: "Secondary Service Zones", type: "textarea",
                              placeholder: "List secondary zones (one per line)" }
                        ]
                    }
                }
            }
        };

        // ===== INITIALIZATION =====
        window.onload = function() {
            checkAuthentication();
        };

        // ===== AUTHENTICATION =====
        function checkAuthentication() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                handleGitHubCallback(code);
            } else {
                const savedUser = localStorage.getItem('titanProUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    initializeApp();
                } else {
                    showLoginScreen();
                }
            }
        }

        function showLoginScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function githubLogin() {
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = 'repo,read:user,read:org';
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CONFIG.GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}`;
            window.location.href = authUrl;
        }

        async function handleGitHubCallback(code) {
            try {
                showNotification('Authenticating...', 'info');
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/github-oauth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = {
                        name: data.user.name || data.user.login,
                        email: data.user.email,
                        role: data.user.role,
                        githubToken: data.access_token,
                        login: data.user.login
                    };
                    
                    localStorage.setItem('titanProUser', JSON.stringify(currentUser));
                    
                    if (data.access_token && data.access_token !== 'demo-token') {
                        octokit = new Octokit({ auth: data.access_token });
                    }
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                    initializeApp();
                } else {
                    showNotification('Authentication failed: ' + (data.error || 'Unknown error'), 'error');
                    showLoginScreen();
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Authentication failed. Please try again.', 'error');
                showLoginScreen();
            }
        }

        function demoLogin(role) {
            currentUser = {
                name: role === 'coach' ? 'Demo Coach' : 'Demo Client',
                email: role === 'coach' ? 'coach@demo.com' : 'client@demo.com',
                role: role,
                githubToken: 'demo-token'
            };
            
            localStorage.setItem('titanProUser', JSON.stringify(currentUser));
            initializeApp();
        }

        function tokenLogin() {
            const instructions = `Enter your GitHub Personal Access Token:

To create a token:
1. Open: https://github.com/settings/tokens
2. Click "Generate new token (classic)"
3. Name it: TPT Client Journey
4. Select these permissions:
   ✓ repo (Full control)
   ✓ read:user (Read user)
   ✓ read:org (Read org membership)
5. Generate and copy the token (starts with ghp_)

Paste your token below:`;

            const token = prompt(instructions);
            
            if (!token) return;
            
            showNotification('Validating token...', 'info');
            
            // Test the token
            fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            })
            .then(response => response.json())
            .then(async userData => {
                if (userData.login) {
                    // Check if user is in organization
                    let role = 'client';
                    try {
                        const orgResponse = await fetch(`https://api.github.com/orgs/titan-pro-technologies/members/${userData.login}`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        if (orgResponse.status === 204) {
                            role = 'coach';
                        }
                    } catch (e) {
                        // Default to client
                    }
                    
                    currentUser = {
                        name: userData.name || userData.login,
                        email: userData.email,
                        role: role,
                        githubToken: token,
                        login: userData.login
                    };
                    
                    localStorage.setItem('titanProUser', JSON.stringify(currentUser));
                    
                    if (token !== 'demo-token') {
                        octokit = new Octokit({ auth: token });
                    }
                    
                    initializeApp();
                    showNotification('Successfully logged in!', 'success');
                } else {
                    showNotification('Invalid token. Please check and try again.', 'error');
                }
            })
            .catch(error => {
                showNotification('Error validating token: ' + error.message, 'error');
            });
        }

        function logout() {
            localStorage.removeItem('titanProUser');
            window.location.reload();
        }

        // ===== APP INITIALIZATION =====
        function initializeApp() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Set user info
            document.getElementById('userName').textContent = currentUser.name;
            const roleElement = document.getElementById('userRole');
            roleElement.textContent = currentUser.role.toUpperCase();
            roleElement.className = currentUser.role === 'coach' 
                ? 'ml-4 px-3 py-1 text-sm rounded-full bg-green-100 text-green-800'
                : 'ml-4 px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800';
            
            // Show client selector for coaches
            if (currentUser.role === 'coach') {
                document.getElementById('clientSelector').classList.remove('hidden');
                loadClientsList();
            } else {
                currentClient = currentUser.email;
                loadClientData();
            }
            
            renderAllTabs();
        }

        // ===== CLIENT MANAGEMENT =====
        async function loadClientsList() {
            if (octokit && currentUser.githubToken !== 'demo-token') {
                try {
                    const { data } = await octokit.rest.repos.getContent({
                        owner: CONFIG.GITHUB_REPO_OWNER,
                        repo: CONFIG.GITHUB_REPO_NAME,
                        path: 'clients'
                    });
                    
                    const dropdown = document.getElementById('clientDropdown');
                    dropdown.innerHTML = '<option value="">Choose a client...</option>';
                    
                    for (const item of data) {
                        if (item.type === 'dir') {
                            const clientEmail = item.name.replace('_at_', '@');
                            dropdown.innerHTML += `<option value="${clientEmail}">${clientEmail}</option>`;
                        }
                    }
                } catch (error) {
                    console.error('Error loading clients:', error);
                    loadDemoClients();
                }
            } else {
                loadDemoClients();
            }
        }

        function loadDemoClients() {
            const demoClients = [
                { email: 'plumbing@example.com', name: 'ABC Plumbing Co.' },
                { email: 'hvac@example.com', name: 'XYZ HVAC Services' }
            ];
            
            const dropdown = document.getElementById('clientDropdown');
            dropdown.innerHTML = '<option value="">Choose a client...</option>';
            demoClients.forEach(client => {
                dropdown.innerHTML += `<option value="${client.email}">${client.name}</option>`;
            });
        }

        function loadClient(clientEmail) {
            if (!clientEmail) return;
            currentClient = clientEmail;
            loadClientData();
        }

        async function loadClientData() {
            if (octokit && currentUser.githubToken !== 'demo-token') {
                try {
                    const path = `clients/${currentClient.replace('@', '_at_')}/journey.json`;
                    const { data } = await octokit.rest.repos.getContent({
                        owner: CONFIG.GITHUB_REPO_OWNER,
                        repo: CONFIG.GITHUB_REPO_NAME,
                        path: path
                    });
                    
                    const content = atob(data.content);
                    clientData[currentClient] = JSON.parse(content);
                    showNotification('Client data loaded', 'success');
                } catch (error) {
                    if (error.status === 404) {
                        clientData[currentClient] = createEmptyClientData();
                        showNotification('New client journey created', 'info');
                    } else {
                        console.error('Error loading client data:', error);
                        clientData[currentClient] = createEmptyClientData();
                    }
                }
            } else {
                // Load from localStorage for demo mode
                const saved = localStorage.getItem(`tpt_${currentClient}`);
                if (saved) {
                    clientData[currentClient] = JSON.parse(saved);
                } else {
                    clientData[currentClient] = createEmptyClientData();
                }
            }
            
            updateClientInfo();
            updateProgress();
            renderAllTabs();
        }

        function createEmptyClientData() {
            const data = {
                metadata: {
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    createdBy: currentUser.name
                }
            };
            
            Object.keys(journeyStructure).forEach(category => {
                const categoryData = journeyStructure[category];
                
                if (categoryData.type === 'list') {
                    // For list-type categories (technicians, employees)
                    data[category] = {
                        items: [],
                        lastUpdated: null
                    };
                } else if (categoryData.sections) {
                    // For categories with sections
                    data[category] = {};
                    Object.keys(categoryData.sections).forEach(section => {
                        const sectionData = categoryData.sections[section];
                        
                        if (sectionData.type === 'list') {
                            // For list-type sections
                            data[category][section] = {
                                items: [],
                                lastUpdated: null
                            };
                        } else {
                            // Regular sections
                            data[category][section] = {};
                            sectionData.fields.forEach(field => {
                                data[category][section][field.id] = {
                                    value: field.type === 'checkbox' ? false : '',
                                    completed: false,
                                    notApplicable: false,
                                    notes: '',
                                    lastUpdated: null
                                };
                            });
                        }
                    });
                } else {
                    // Regular categories
                    data[category] = {};
                }
            });
            
            return data;
        }

        function addNewClient() {
            const email = prompt('Enter client email:');
            if (!email) return;
            
            const name = prompt('Enter company name:');
            if (!name) return;
            
            currentClient = email;
            clientData[currentClient] = createEmptyClientData();
            clientData[currentClient].metadata.companyName = name;
            
            loadClientsList();
            document.getElementById('clientDropdown').value = email;
            loadClientData();
            
            saveAllData();
        }

        // ===== UI RENDERING =====
        function renderAllTabs() {
            if (!currentClient) return;
            
            Object.keys(journeyStructure).forEach(category => {
                renderTab(category);
            });
            
            // Make sure to update progress after rendering
            updateProgress();
        }

        function renderTab(category) {
            const tabElement = document.getElementById(`${category}-tab`);
            const structure = journeyStructure[category];
            const data = clientData[currentClient]?.[category] || {};
            
            if (structure.type === 'list') {
                // Render list-type categories (technicians, employees)
                renderListCategory(tabElement, category, structure, data);
            } else if (structure.sections) {
                // Render categories with sections
                let html = '<div class="space-y-6">';
                
                Object.keys(structure.sections).forEach(sectionKey => {
                    const section = structure.sections[sectionKey];
                    
                    if (section.type === 'list') {
                        // Render list-type sections
                        html += renderListSection(category, sectionKey, section, data[sectionKey] || { items: [] });
                    } else {
                        // Regular sections
                        html += `
                            <div class="border border-gray-200 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">${section.title}</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        `;
                        
                        section.fields.forEach(field => {
                            const fieldData = data[sectionKey]?.[field.id] || {
                                value: field.type === 'checkbox' ? false : '',
                                completed: false,
                                notApplicable: false,
                                notes: ''
                            };
                            
                            html += renderField(category, sectionKey, field, fieldData);
                        });
                        
                        html += '</div></div>';
                    }
                });
                
                html += '</div>';
                tabElement.innerHTML = html;
            }
        }

        function renderField(category, section, field, fieldData) {
            const fieldId = `${category}_${section}_${field.id}`;
            const isDisabled = fieldData.notApplicable;
            const isCoach = currentUser.role === 'coach';
            
            let html = `<div class="${field.type === 'textarea' ? 'md:col-span-2' : ''}">`;
            
            // Field label and N/A checkbox
            html += `
                <div class="flex justify-between items-center mb-2">
                    <label for="${fieldId}" class="text-sm font-medium text-gray-700 ${isDisabled ? 'line-through opacity-50' : ''}">
                        ${field.label}
                        ${field.required ? '<span class="text-red-500">*</span>' : ''}
                    </label>
                    ${isCoach ? `
                        <label class="flex items-center text-xs">
                            <input type="checkbox" 
                                   ${fieldData.notApplicable ? 'checked' : ''}
                                   onchange="toggleNotApplicable('${category}', '${section}', '${field.id}')"
                                   class="mr-1 rounded">
                            <span class="text-gray-500">N/A</span>
                        </label>
                    ` : ''}
                </div>
            `;
            
            // Field input
            if (field.type === 'checkbox') {
                html += `
                    <div class="flex items-center">
                        <input type="checkbox" 
                               id="${fieldId}"
                               ${fieldData.value ? 'checked' : ''}
                               ${isDisabled ? 'disabled' : ''}
                               onchange="updateField('${category}', '${section}', '${field.id}', this.checked)"
                               class="w-4 h-4 text-blue-600 rounded">
                        <label for="${fieldId}" class="ml-2 text-sm text-gray-600">
                            ${fieldData.value ? 'Completed' : 'Not completed'}
                        </label>
                    </div>
                `;
            } else if (field.type === 'select') {
                html += `
                    <select id="${fieldId}"
                            ${isDisabled ? 'disabled' : ''}
                            onchange="updateField('${category}', '${section}', '${field.id}', this.value)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="">Select...</option>
                        ${field.options.map(opt => `
                            <option value="${opt}" ${fieldData.value === opt ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                `;
            } else if (field.type === 'textarea') {
                html += `
                    <textarea id="${fieldId}"
                              ${isDisabled ? 'disabled' : ''}
                              onchange="updateField('${category}', '${section}', '${field.id}', this.value)"
                              placeholder="${field.placeholder || ''}"
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">${fieldData.value || ''}</textarea>
                `;
            } else {
                html += `
                    <input type="text"
                           id="${fieldId}"
                           value="${fieldData.value || ''}"
                           ${isDisabled ? 'disabled' : ''}
                           onchange="updateField('${category}', '${section}', '${field.id}', this.value)"
                           placeholder="${field.placeholder || ''}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                `;
            }
            
            // Notes field
            html += `
                <div class="mt-2">
                    <input type="text"
                           placeholder="Notes..."
                           value="${fieldData.notes || ''}"
                           ${isDisabled ? 'disabled' : ''}
                           onchange="updateFieldNotes('${category}', '${section}', '${field.id}', this.value)"
                           class="w-full px-2 py-1 border border-gray-200 rounded text-xs">
                </div>
            `;
            
            html += '</div>';
            return html;
        }

        // ===== LIST RENDERING FUNCTIONS =====
        function renderListCategory(tabElement, category, structure, data) {
            const items = data.items || [];
            let html = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">${structure.title}</h2>
                        <button onclick="addListItem('${category}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Add ${structure.title.slice(0, -1)}
                        </button>
                    </div>
            `;
            
            if (items.length === 0) {
                html += `
                    <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <i class="fas fa-users text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-600">No ${structure.title.toLowerCase()} added yet</p>
                        <button onclick="addListItem('${category}')" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Add First ${structure.title.slice(0, -1)}
                        </button>
                    </div>
                `;
            } else {
                html += '<div class="space-y-4">';
                items.forEach((item, index) => {
                    html += renderListItem(category, structure, item, index);
                });
                html += '</div>';
            }
            
            html += '</div>';
            tabElement.innerHTML = html;
        }

        function renderListSection(category, sectionKey, section, sectionData) {
            const items = sectionData.items || [];
            let html = `
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">${section.title}</h3>
                        <button onclick="addListItem('${category}', '${sectionKey}')" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            <i class="fas fa-plus mr-2"></i>Add ${section.itemLabel || 'Item'}
                        </button>
                    </div>
            `;
            
            if (items.length === 0) {
                html += `
                    <div class="bg-gray-50 border border-dashed border-gray-300 rounded p-4 text-center text-sm">
                        <p class="text-gray-600">No ${section.title.toLowerCase()} added yet</p>
                    </div>
                `;
            } else {
                html += '<div class="space-y-3">';
                items.forEach((item, index) => {
                    html += renderSectionListItem(category, sectionKey, section, item, index);
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function renderListItem(category, structure, item, index) {
            const isExpanded = item._expanded !== false;
            let html = `
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50" onclick="toggleListItem('${category}', ${index})">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-chevron-${isExpanded ? 'down' : 'right'} text-gray-400"></i>
                            <div>
                                <div class="font-medium text-gray-900">
                                    ${item.firstName || 'New'} ${item.lastName || structure.title.slice(0, -1)}
                                </div>
                                <div class="text-sm text-gray-500">
                                    ${item.email || 'No email'} ${item.employeeId ? `• ID: ${item.employeeId}` : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); removeListItem('${category}', ${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    ${isExpanded ? `
                        <div class="border-t border-gray-200 p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${structure.fields.map(field => renderListField(category, null, field, item, index)).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            return html;
        }

        function renderSectionListItem(category, sectionKey, section, item, index) {
            let html = `
                <div class="bg-gray-50 rounded p-3 border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-medium text-gray-800">
                            ${item.skillName || item.jobTypeName || `${section.itemLabel} ${index + 1}`}
                        </div>
                        <button onclick="removeListItem('${category}', ${index}, '${sectionKey}')" class="text-red-500 hover:text-red-700 text-sm">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${section.fields.map(field => renderListField(category, sectionKey, field, item, index)).join('')}
                    </div>
                </div>
            `;
            return html;
        }

        function renderListField(category, section, field, item, itemIndex) {
            const fieldId = `${category}_${section || 'item'}_${itemIndex}_${field.id}`;
            const value = item[field.id] || (field.type === 'checkbox' ? false : '');
            
            let html = `<div class="${field.type === 'textarea' ? 'md:col-span-2' : ''}">`;
            html += `<label for="${fieldId}" class="text-sm font-medium text-gray-700 mb-1 block">
                ${field.label}
                ${field.required ? '<span class="text-red-500">*</span>' : ''}
            </label>`;
            
            if (field.type === 'checkbox') {
                html += `
                    <input type="checkbox" 
                           id="${fieldId}"
                           ${value ? 'checked' : ''}
                           onchange="updateListField('${category}', ${itemIndex}, '${field.id}', this.checked, ${section ? `'${section}'` : null})"
                           class="w-4 h-4 text-blue-600 rounded">
                `;
            } else if (field.type === 'select') {
                html += `
                    <select id="${fieldId}"
                            onchange="updateListField('${category}', ${itemIndex}, '${field.id}', this.value, ${section ? `'${section}'` : null})"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="">Select...</option>
                        ${field.options.map(opt => `
                            <option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                `;
            } else if (field.type === 'date') {
                html += `
                    <input type="date"
                           id="${fieldId}"
                           value="${value || ''}"
                           onchange="updateListField('${category}', ${itemIndex}, '${field.id}', this.value, ${section ? `'${section}'` : null})"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                `;
            } else if (field.type === 'number') {
                html += `
                    <input type="number"
                           id="${fieldId}"
                           value="${value || ''}"
                           onchange="updateListField('${category}', ${itemIndex}, '${field.id}', this.value, ${section ? `'${section}'` : null})"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                `;
            } else if (field.type === 'multiselect') {
                // For skills multiselect, we'll use checkboxes for now
                const selectedSkills = value || [];
                const availableSkills = getAvailableSkills();
                html += `
                    <div class="border border-gray-300 rounded-lg p-2 max-h-32 overflow-y-auto">
                        ${availableSkills.length > 0 ? 
                            availableSkills.map(skill => `
                                <label class="flex items-center space-x-2 py-1">
                                    <input type="checkbox" 
                                           ${selectedSkills.includes(skill) ? 'checked' : ''}
                                           onchange="updateMultiselect('${category}', ${itemIndex}, '${field.id}', '${skill}', this.checked, ${section ? `'${section}'` : null})"
                                           class="rounded text-blue-600">
                                    <span class="text-sm">${skill}</span>
                                </label>
                            `).join('') :
                            '<p class="text-sm text-gray-500">Add skills in Skills tab first</p>'
                        }
                    </div>
                `;
            } else {
                html += `
                    <input type="text"
                           id="${fieldId}"
                           value="${value || ''}"
                           onchange="updateListField('${category}', ${itemIndex}, '${field.id}', this.value, ${section ? `'${section}'` : null})"
                           placeholder="${field.placeholder || ''}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                `;
            }
            
            html += '</div>';
            return html;
        }

        // ===== LIST DATA FUNCTIONS =====
        function addListItem(category, section = null) {
            if (!clientData[currentClient]) return;
            
            const newItem = { _expanded: true };
            
            if (section) {
                // Adding to a section
                if (!clientData[currentClient][category][section]) {
                    clientData[currentClient][category][section] = { items: [] };
                }
                clientData[currentClient][category][section].items.push(newItem);
                clientData[currentClient][category][section].lastUpdated = new Date().toISOString();
            } else {
                // Adding to category
                if (!clientData[currentClient][category]) {
                    clientData[currentClient][category] = { items: [] };
                }
                clientData[currentClient][category].items.push(newItem);
                clientData[currentClient][category].lastUpdated = new Date().toISOString();
            }
            
            renderTab(category);
            updateProgress();
            
            // Update counts if adding technicians or employees
            if (category === 'technicians' || category === 'employees') {
                updateClientInfo();
            }
        }

        function removeListItem(category, index, section = null) {
            if (!clientData[currentClient]) return;
            
            if (confirm('Are you sure you want to remove this item?')) {
                if (section) {
                    clientData[currentClient][category][section].items.splice(index, 1);
                    clientData[currentClient][category][section].lastUpdated = new Date().toISOString();
                } else {
                    clientData[currentClient][category].items.splice(index, 1);
                    clientData[currentClient][category].lastUpdated = new Date().toISOString();
                }
                
                renderTab(category);
                updateProgress();
                
                // Update counts if removing technicians or employees
                if (category === 'technicians' || category === 'employees') {
                    updateClientInfo();
                }
            }
        }

        function toggleListItem(category, index) {
            if (!clientData[currentClient]) return;
            
            const item = clientData[currentClient][category].items[index];
            item._expanded = !item._expanded;
            renderTab(category);
        }

        function updateListField(category, itemIndex, fieldId, value, section = null) {
            if (!clientData[currentClient]) return;
            
            if (section) {
                clientData[currentClient][category][section].items[itemIndex][fieldId] = value;
                clientData[currentClient][category][section].lastUpdated = new Date().toISOString();
            } else {
                clientData[currentClient][category].items[itemIndex][fieldId] = value;
                clientData[currentClient][category].lastUpdated = new Date().toISOString();
            }
            
            // Update display if it's a name field
            if (fieldId === 'firstName' || fieldId === 'lastName' || fieldId === 'skillName' || fieldId === 'jobTypeName') {
                renderTab(category);
            }
            
            // Update counts if adding technicians or employees
            if (category === 'technicians' || category === 'employees') {
                updateClientInfo();
            }
        }

        function updateMultiselect(category, itemIndex, fieldId, value, checked, section = null) {
            if (!clientData[currentClient]) return;
            
            let item;
            if (section) {
                item = clientData[currentClient][category][section].items[itemIndex];
            } else {
                item = clientData[currentClient][category].items[itemIndex];
            }
            
            if (!item[fieldId]) {
                item[fieldId] = [];
            }
            
            if (checked) {
                if (!item[fieldId].includes(value)) {
                    item[fieldId].push(value);
                }
            } else {
                item[fieldId] = item[fieldId].filter(v => v !== value);
            }
            
            if (section) {
                clientData[currentClient][category][section].lastUpdated = new Date().toISOString();
            } else {
                clientData[currentClient][category].lastUpdated = new Date().toISOString();
            }
        }

        function getAvailableSkills() {
            if (!clientData[currentClient]?.skills?.skillsList?.items) return [];
            
            return clientData[currentClient].skills.skillsList.items
                .map(skill => skill.skillName)
                .filter(name => name);
        }

        // ===== DATA UPDATES =====
        function updateField(category, section, fieldId, value) {
            if (!clientData[currentClient]) return;
            
            if (!clientData[currentClient][category]) {
                clientData[currentClient][category] = {};
            }
            if (!clientData[currentClient][category][section]) {
                clientData[currentClient][category][section] = {};
            }
            if (!clientData[currentClient][category][section][fieldId]) {
                clientData[currentClient][category][section][fieldId] = {};
            }
            
            clientData[currentClient][category][section][fieldId].value = value;
            clientData[currentClient][category][section][fieldId].lastUpdated = new Date().toISOString();
            clientData[currentClient][category][section][fieldId].completed = !!value;
            
            updateProgress();
            document.getElementById('lastUpdatedDisplay').textContent = new Date().toLocaleString();
        }

        function updateFieldNotes(category, section, fieldId, notes) {
            if (!clientData[currentClient]) return;
            
            clientData[currentClient][category][section][fieldId].notes = notes;
        }

        function toggleNotApplicable(category, section, fieldId) {
            if (!clientData[currentClient]) return;
            
            const isNA = !clientData[currentClient][category][section][fieldId].notApplicable;
            clientData[currentClient][category][section][fieldId].notApplicable = isNA;
            
            renderTab(category);
            updateProgress();
        }

        // ===== PROGRESS TRACKING =====
        function updateProgress() {
            if (!currentClient || !clientData[currentClient]) return;
            
            let total = 0;
            let completed = 0;
            let inProgress = 0;
            let notApplicable = 0;
            
            Object.keys(journeyStructure).forEach(category => {
                const categoryStructure = journeyStructure[category];
                
                if (categoryStructure.type === 'list') {
                    // For list categories, count having at least one item as completed
                    total++;
                    if (clientData[currentClient][category]?.items?.length > 0) {
                        completed++;
                    }
                } else if (categoryStructure.sections) {
                    Object.keys(categoryStructure.sections).forEach(section => {
                        const sectionStructure = categoryStructure.sections[section];
                        
                        if (sectionStructure.type === 'list') {
                            // For list sections, count having at least one item as completed
                            total++;
                            if (clientData[currentClient][category]?.[section]?.items?.length > 0) {
                                completed++;
                            }
                        } else {
                            // Regular sections
                            sectionStructure.fields.forEach(field => {
                                const fieldData = clientData[currentClient]?.[category]?.[section]?.[field.id];
                                if (fieldData) {
                                    total++;
                                    if (fieldData.notApplicable) {
                                        notApplicable++;
                                    } else if (fieldData.completed || fieldData.value) {
                                        completed++;
                                    } else if (fieldData.value === '' && fieldData.notes) {
                                        inProgress++;
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            const applicableTotal = total - notApplicable;
            const percentage = applicableTotal > 0 ? Math.round((completed / applicableTotal) * 100) : 0;
            
            // Update progress circle
            document.getElementById('progressPercent').textContent = `${percentage}%`;
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 54;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // Update counts
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('notApplicableCount').textContent = notApplicable;
        }

        function updateClientInfo() {
            if (!currentClient || !clientData[currentClient]) return;
            
            const data = clientData[currentClient];
            document.getElementById('tenantIdDisplay').textContent = 
                data.settings?.tenant?.tenantId?.value || '-';
            document.getElementById('companyDisplay').textContent = 
                data.settings?.company?.companyName?.value || data.metadata?.companyName || currentClient;
            document.getElementById('technicianCount').textContent = 
                data.technicians?.items?.length || 0;
            document.getElementById('employeeCount').textContent = 
                data.employees?.items?.length || 0;
            document.getElementById('lastUpdatedDisplay').textContent = 
                data.metadata?.lastUpdated ? new Date(data.metadata.lastUpdated).toLocaleString() : '-';
        }

        // ===== TAB SWITCHING =====
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('text-blue-600', 'border-blue-600');
                    btn.classList.remove('text-gray-500', 'border-transparent');
                } else {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                }
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // ===== SAVE FUNCTIONALITY =====
        async function saveAllData() {
            if (!currentClient || !clientData[currentClient]) return;
            
            // Update metadata
            clientData[currentClient].metadata.lastUpdated = new Date().toISOString();
            
            if (octokit && currentUser.githubToken !== 'demo-token') {
                try {
                    const path = `clients/${currentClient.replace('@', '_at_')}/journey.json`;
                    const content = btoa(JSON.stringify(clientData[currentClient], null, 2));
                    
                    // Check if file exists
                    let sha;
                    try {
                        const { data } = await octokit.rest.repos.getContent({
                            owner: CONFIG.GITHUB_REPO_OWNER,
                            repo: CONFIG.GITHUB_REPO_NAME,
                            path: path
                        });
                        sha = data.sha;
                    } catch (e) {
                        // File doesn't exist yet
                    }
                    
                    await octokit.rest.repos.createOrUpdateFileContents({
                        owner: CONFIG.GITHUB_REPO_OWNER,
                        repo: CONFIG.GITHUB_REPO_NAME,
                        path: path,
                        message: `Update journey data for ${currentClient}`,
                        content: content,
                        sha: sha
                    });
                    
                    showNotification('Data saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving to GitHub:', error);
                    // Save to localStorage as fallback
                    localStorage.setItem(`tpt_${currentClient}`, JSON.stringify(clientData[currentClient]));
                    showNotification('Saved locally. GitHub sync failed.', 'warning');
                }
            } else {
                // Demo mode - save to localStorage
                localStorage.setItem(`tpt_${currentClient}`, JSON.stringify(clientData[currentClient]));
                showNotification('Data saved locally (demo mode)', 'info');
            }
        }

        // ===== EXPORT FUNCTIONALITY =====
        function exportData() {
            if (!currentClient || !clientData[currentClient]) return;
            
            const exportData = {
                client: currentClient,
                exportDate: new Date().toISOString(),
                exportedBy: currentUser.name,
                summary: {
                    techniciansCount: clientData[currentClient].technicians?.items?.length || 0,
                    employeesCount: clientData[currentClient].employees?.items?.length || 0,
                    skillsCount: clientData[currentClient].skills?.skillsList?.items?.length || 0,
                    jobTypesCount: clientData[currentClient].skills?.jobTypes?.items?.length || 0
                },
                data: clientData[currentClient]
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tpt-journey-${currentClient}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        // ===== NOTIFICATIONS =====
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            }[type];
            
            notification.className = `notification bg-white rounded-lg shadow-lg p-4 mb-2 border-l-4 ${bgColor}`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-gray-800">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    </script>
</body>
</html>
